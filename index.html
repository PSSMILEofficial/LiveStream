<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Sulove Live â€” Single File (Fixed)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; background:#f4f6f8; color:#111; margin:0; padding:18px; display:flex; justify-content:center; }
    .wrap { width:100%; max-width:900px; }
    .card { background:#fff; border-radius:10px; padding:18px; box-shadow:0 6px 20px rgba(0,0,0,0.06); margin-bottom:12px; }
    h1,h2 { margin:6px 0 12px 0; font-weight:600; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    input[type=text], input[type=password], textarea { width:100%; padding:10px; border-radius:6px; border:1px solid #ddd; box-sizing:border-box; }
    button { background:#111; color:#fff; border:none; padding:10px 14px; border-radius:6px; cursor:pointer; }
    button.ghost { background:transparent; color:#111; border:1px solid #ddd; }
    video { width:100%; background:#000; border-radius:8px; display:block; margin-top:10px; }
    .chatBox { height:220px; overflow:auto; background:#fafafa; padding:8px; border-radius:6px; border:1px solid #eee; text-align:left; }
    .chat-msg { margin:6px 0; padding:6px; border-radius:4px; background:transparent; }
    .chat-msg b { margin-right:6px; }
    .small { font-size:13px; color:#666; }
    .center { text-align:center; }
    .muted { color:#666; font-size:13px; }
    .controls { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .system-msg { color: #2b8f2b; font-weight:600; } /* green for system with time */
    @media (max-width:600px){ .row{flex-direction:column;} .controls{flex-direction:column;} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card center">
      <h1>ðŸ”¥ Sulove Live Stream</h1>
      <p class="muted">Admin password protected. Admin can share PC or Android screen. Viewers enter a name and watch instantly.</p>
    </div>

    <!-- LOGIN / CHOICE -->
    <div class="card" id="entryCard">
      <h2>Enter</h2>
      <div class="row">
        <input id="nameInput" type="text" placeholder="If viewer: type your name here (example: Sita). If admin: leave name blank and enter password below." />
        <input id="passwordInput" type="password" placeholder="Admin password" />
        <button id="enterBtn">Enter</button>
      </div>
      <p class="small">If you enter correct admin password, you'll see the Admin controls. Otherwise you'll join as a viewer.</p>
    </div>

    <!-- ADMIN PANEL -->
    <div class="card" id="adminCard" style="display:none;">
      <h2>Admin Panel</h2>
      <div class="row">
        <button id="startBtn">Start Screen Share</button>
        <button id="stopBtn" class="ghost">Stop Sharing</button>
        <button id="clearChatBtn" class="ghost">Clear Chat</button>
      </div>

      <div style="margin-top:10px;">
        <div class="small">Viewer Count: <strong id="viewerCountAdmin">0</strong></div>
      </div>

      <video id="localVideo" autoplay playsinline muted></video>

      <h3 style="margin-top:12px">Chat (Admin)</h3>
      <div class="chatBox" id="adminChatBox" aria-live="polite"></div>

      <div class="row" style="margin-top:8px;">
        <input id="adminMsg" type="text" placeholder="Type message as Admin and press Send" />
        <button id="sendAdminMsg">Send</button>
      </div>
    </div>

    <!-- VIEWER PANEL -->
    <div class="card" id="viewerCard" style="display:none;">
      <h2>Viewer</h2>

      <div class="small">You are: <strong id="viewerNameLabel"></strong></div>
      <div style="margin-top:8px;">
        <video id="remoteVideo" autoplay playsinline controls></video>
      </div>

      <div class="controls">
        <button id="fullscreenBtn">Full Screen</button>
        <button id="leaveBtn" class="ghost">Leave</button>
      </div>

      <div style="margin-top:10px;">
        <div class="small">Viewer Count: <strong id="viewerCountViewer">0</strong></div>
      </div>

      <h3 style="margin-top:12px">Live Chat</h3>
      <div class="chatBox" id="viewerChatBox" aria-live="polite"></div>

      <div class="row" style="margin-top:8px;">
        <input id="msgInput" type="text" placeholder="Type message..." />
        <button id="sendMsg">Send</button>
      </div>
    </div>

    <div class="card small center" style="margin-top:10px;">
      <div>Built with Firebase Realtime DB as signalling (free). For iOS broadcasting you need a native app (ReplayKit).</div>
    </div>
  </div>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
/* ============================
   CONFIG: your provided Firebase config
   ============================ */
const firebaseConfig = {
  apiKey: "AIzaSyCG7g35KGyX9F9utI-lnkaViM7mQzWrO3A",
  authDomain: "livestreamproject-3f19c.firebaseapp.com",
  databaseURL: "https://livestreamproject-3f19c-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "livestreamproject-3f19c",
  storageBucket: "livestreamproject-3f19c.firebasestorage.app",
  messagingSenderId: "639236892430",
  appId: "1:639236892430:web:c2a888d27759487d91d95f"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ========== App constants ========== */
const ADMIN_PASSWORD = "Sulove@123";

/* ========== UI refs ========== */
const entryCard = document.getElementById('entryCard');
const adminCard = document.getElementById('adminCard');
const viewerCard = document.getElementById('viewerCard');

const nameInput = document.getElementById('nameInput');
const passwordInput = document.getElementById('passwordInput');
const enterBtn = document.getElementById('enterBtn');

const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const localVideo = document.getElementById('localVideo');

const remoteVideo = document.getElementById('remoteVideo');
const fullscreenBtn = document.getElementById('fullscreenBtn');
const leaveBtn = document.getElementById('leaveBtn');

const viewerCountAdmin = document.getElementById('viewerCountAdmin');
const viewerCountViewer = document.getElementById('viewerCountViewer');
const viewerNameLabel = document.getElementById('viewerNameLabel');

const adminChatBox = document.getElementById('adminChatBox');
const viewerChatBox = document.getElementById('viewerChatBox');

const adminMsg = document.getElementById('adminMsg');
const sendAdminMsg = document.getElementById('sendAdminMsg');

const msgInput = document.getElementById('msgInput');
const sendMsg = document.getElementById('sendMsg');
const clearChatBtn = document.getElementById('clearChatBtn');

/* ========== Application state ========== */
let isAdmin = false;
let localStream = null;
let pcs = {}; // map viewerId -> RTCPeerConnection (admin side)
let viewerId = null; // viewer unique id when acting as viewer

/* ========== Helpers ========== */
function genId(len=8){ const s = 'abcdefghijklmnopqrstuvwxyz0123456789'; return Array.from({length:len},()=>s[Math.floor(Math.random()*s.length)]).join(''); }
function nowISO(){ return new Date().toISOString(); }
function nowHHMM(){ const d=new Date(); return String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0'); }
function randomColor(){ return '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6,'0'); }

/* unified append: add message element to BOTH admin & viewer chat boxes */
function appendChatToAll(html, isSystem=false) {
  const divAdmin = document.createElement('div');
  divAdmin.className = 'chat-msg';
  divAdmin.innerHTML = html;
  if(isSystem) divAdmin.classList.add('system-msg');
  adminChatBox.appendChild(divAdmin);

  const divViewer = document.createElement('div');
  divViewer.className = 'chat-msg';
  divViewer.innerHTML = html;
  if(isSystem) divViewer.classList.add('system-msg');
  viewerChatBox.appendChild(divViewer);

  // auto-scroll both
  adminChatBox.scrollTop = adminChatBox.scrollHeight;
  viewerChatBox.scrollTop = viewerChatBox.scrollHeight;
}

/* ========== Viewer Count management ========== */
const viewerCountRef = db.ref('meta/viewerCount');

/* ensure viewer count is present */
viewerCountRef.once('value', snap => { if (snap.val() === null) viewerCountRef.set(0); });
viewerCountRef.on('value', snap => {
  const v = snap.val() || 0;
  viewerCountAdmin.innerText = v;
  viewerCountViewer.innerText = v;
});

/* increment / decrement safely using transaction */
async function incViewerCount(){
  await viewerCountRef.transaction(n => (n||0) + 1);
}
async function decViewerCount(){
  await viewerCountRef.transaction(n => Math.max(0, (n||0) - 1));
}

/* cleanup on unload (for viewers) */
window.addEventListener('beforeunload', () => {
  if(!isAdmin && viewerId) {
    decViewerCount();
    db.ref('viewers/' + viewerId).remove().catch(()=>{});
    // mark disconnected in messages
    pushSystem(`${getDisplayName()} left`);
  }
  // if admin leaves, stop stream and clear signalling (admin should press Stop)
});

/* ========== Chat (messages stored in /messages) ========== */
const messagesRef = db.ref('messages');

/* helper: determine display name for current client */
function getDisplayName(){
  if(isAdmin) return 'Admin';
  const name = (nameInput && nameInput.value && nameInput.value.trim()) ? nameInput.value.trim() : (localStorage.getItem('sulove_name') || 'Anonymous');
  return name;
}

/* Colors: admin fixed red; viewers get persistent color stored in localStorage */
function getLocalColor() {
  if(isAdmin) return 'red';
  let c = localStorage.getItem('sulove_color');
  if(!c) { c = randomColor(); localStorage.setItem('sulove_color', c); }
  return c;
}

/* push a normal chat (no time) */
function pushChat(name, text, color){
  messagesRef.push({
    name: name,
    text: text,
    color: color || (name === 'Admin' ? 'red' : (localStorage.getItem('sulove_color') || randomColor())),
    system: false,
    ts: firebase.database.ServerValue.TIMESTAMP
  });
}

/* push a system message (with time) */
function pushSystem(text){
  const time = nowHHMM();
  messagesRef.push({
    name: 'SYSTEM',
    text: text,
    system: true,
    time: time,
    ts: firebase.database.ServerValue.TIMESTAMP
  });
}

/* render incoming messages */
messagesRef.on('child_added', snap => {
  const msg = snap.val();
  if(!msg) return;
  if(msg.system){
    // show time only for system messages (green)
    const html = `[${msg.time}] SYSTEM: ${escapeHtml(msg.text)}`;
    appendChatToAll(`<span>${html}</span>`, true);
  } else {
    // normal message (no time)
    const color = msg.color || (msg.name === 'Admin' ? 'red' : '#000');
    const nameEsc = escapeHtml(msg.name);
    const textEsc = escapeHtml(msg.text);
    const html = `<b style="color:${color};">${nameEsc}</b>: <span>${textEsc}</span>`;
    appendChatToAll(html, false);
  }
});

/* Clear chat (admin action) */
clearChatBtn.onclick = () => {
  if(!isAdmin) return;
  db.ref('messages').remove().then(()=> {
    adminChatBox.innerHTML = '';
    viewerChatBox.innerHTML = '';
    pushSystem('Chat cleared by Admin');
  }).catch(()=>{});
};

/* escape HTML to prevent injection */
function escapeHtml(s){
  if(!s && s !== 0) return '';
  return String(s).replace(/[&<>"']/g, (m)=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]) );
}

/* ========== Admin / Viewer entry ========== */
enterBtn.onclick = () => {
  const pass = passwordInput.value.trim();
  const name = nameInput.value.trim();

  if(pass === ADMIN_PASSWORD) {
    // admin mode
    isAdmin = true;
    entryCard.style.display='none';
    adminCard.style.display='block';
    viewerCard.style.display='none';
    // admin color red
    localStorage.setItem('sulove_name', 'Admin');
    localStorage.setItem('sulove_color', 'red');
    appendLocalSystem('Admin signed in');
    pushSystem('Admin signed in');
    // admin listens for viewer join requests
    listenForViewerRequests();
  } else {
    // viewer mode
    isAdmin = false;
    viewerId = genId(10);
    entryCard.style.display='none';
    adminCard.style.display='none';
    viewerCard.style.display='block';

    const displayName = name || ('Viewer' + genId(3));
    nameInput.value = displayName; // keep in input for later edits
    viewerNameLabel.innerText = displayName;
    localStorage.setItem('sulove_name', displayName);

    // set color if not present
    if(!localStorage.getItem('sulove_color')) localStorage.setItem('sulove_color', randomColor());

    // set presence
    db.ref('viewers/' + viewerId).set({ name: displayName, joined: nowISO() });
    incViewerCount();
    // signal join
    requestOfferAsViewer(viewerId, displayName);
    pushSystem(displayName + ' joined');
    appendLocalSystem('You joined as ' + displayName);

    // remove presence on unload (extra)
    window.addEventListener('unload', ()=> { db.ref('viewers/' + viewerId).remove(); });
  }
};

/* small convenience: add system message locally only (no push) */
function appendLocalSystem(text){
  const time = nowHHMM();
  appendChatToAll(`[${time}] SYSTEM: ${escapeHtml(text)}`, true);
}

/* ========== Admin: listen for viewer join requests ========== */
/* Same mechanism as your original code */
const requestsRef = db.ref('requests');
const offersRef = db.ref('offers');
const answersRef = db.ref('answers');
const iceViewerRefRoot = db.ref('ice/viewer');
const iceAdminRefRoot = db.ref('ice/admin');

async function listenForViewerRequests(){
  requestsRef.on('child_added', async snap => {
    const vId = snap.key;
    const data = snap.val();
    if(!vId) return;
    if(!localStream) {
      // notify viewer that broadcaster not ready
      offersRef.child(vId).set(JSON.stringify({ error: 'broadcaster-not-ready' }));
      return;
    }
    // create peer connection for this viewer
    const pc = new RTCPeerConnection({
      iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
    });
    pcs[vId] = pc;

    // add tracks
    localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

    // admin -> viewer ICE
    pc.onicecandidate = e => {
      if(e.candidate) {
        iceAdminRefRoot.child(vId).push(JSON.stringify(e.candidate));
      }
    };

    // create offer
    try {
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      await offersRef.child(vId).set(JSON.stringify(offer));
    } catch(err){ console.error('offer error', err); }

    // listen for answer for this viewer
    answersRef.child(vId).on('value', async s => {
      const val = s.val();
      if(!val) return;
      try {
        const answer = JSON.parse(val);
        await pc.setRemoteDescription(answer);
        requestsRef.child(vId).remove().catch(()=>{});
      } catch(e){ console.warn('answer handling error', e); }
    });

    // listen for ICE from viewer
    iceViewerRefRoot.child(vId).on('child_added', snapIce => {
      try {
        const ice = JSON.parse(snapIce.val());
        pc.addIceCandidate(new RTCIceCandidate(ice)).catch(()=>{});
      } catch(e){ console.warn('ice add error', e); }
    });

    pc.onconnectionstatechange = () => {
      if(pc.connectionState === 'closed' || pc.connectionState === 'failed' || pc.connectionState === 'disconnected'){
        answersRef.child(vId).off();
        iceViewerRefRoot.child(vId).off();
        iceAdminRefRoot.child(vId).remove().catch(()=>{});
        offersRef.child(vId).remove().catch(()=>{});
        delete pcs[vId];
      }
    };
  });
}

/* ========== Admin: start/stop sharing ========== */
startBtn.onclick = async () => {
  try {
    localStream = await navigator.mediaDevices.getDisplayMedia({ video:true, audio:true });
  } catch(e){
    alert('Could not getDisplayMedia(): ' + (e.message || e));
    return;
  }

  localVideo.srcObject = localStream;
  appendLocalSystem('Admin started sharing');
  pushSystem('Admin started sharing');
  db.ref('meta/broadcaster').set({ online: true, startedAt: nowISO() });
};

stopBtn.onclick = () => {
  if(localStream) {
    localStream.getTracks().forEach(t=>t.stop());
    localStream = null;
    localVideo.srcObject = null;
  }
  db.ref('meta/broadcaster').set({ online: false, stoppedAt: nowISO() });
  requestsRef.remove().catch(()=>{});
  offersRef.remove().catch(()=>{});
  answersRef.remove().catch(()=>{});
  iceViewerRefRoot.remove().catch(()=>{});
  iceAdminRefRoot.remove().catch(()=>{});
  appendLocalSystem('Admin stopped sharing');
  pushSystem('Admin stopped sharing');
  Object.keys(pcs).forEach(id => {
    try { pcs[id].close(); } catch(e){}
    answersRef.child(id).off();
    iceViewerRefRoot.child(id).off();
  });
  pcs = {};
};

/* ========== Viewer: request offer and connect ========== */
async function requestOfferAsViewer(myViewerId, name){
  await requestsRef.child(myViewerId).set({ name: name, createdAt: nowISO() });

  const pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });

  // viewer -> admin ICE
  pc.onicecandidate = e => {
    if(e.candidate) {
      iceViewerRefRoot.child(myViewerId).push(JSON.stringify(e.candidate));
    }
  };

  // viewer receives tracks
  pc.ontrack = e => {
    remoteVideo.srcObject = e.streams[0];
  };

  // listen for admin offer for this viewer
  offersRef.child(myViewerId).on('value', async snap => {
    const val = snap.val();
    if(!val) return;
    // admin may set an error object
    try {
      if(typeof val === 'string'){
        const offerObj = JSON.parse(val);
        if(offerObj && offerObj.error === 'broadcaster-not-ready'){
          appendLocalSystem('System: broadcaster not ready yet. Please wait...');
          return;
        }
        await pc.setRemoteDescription(offerObj);
      } else {
        // val may be object if not stringified for some reason
        await pc.setRemoteDescription(val);
      }
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      await answersRef.child(myViewerId).set(JSON.stringify(answer));
      // Listen for admin ICE candidates
      iceAdminRefRoot.child(myViewerId).on('child_added', s => {
        try {
          const ice = JSON.parse(s.val());
          pc.addIceCandidate(new RTCIceCandidate(ice)).catch(()=>{});
        } catch(e){ console.warn('add admin ice', e); }
      });
    } catch(e){ console.error('viewer offer handling error', e); }
  });

  // save presence connected time
  db.ref('viewers/' + myViewerId).update({ connectedAt: nowISO() });

  // cleanup request node after 60s (optional)
  setTimeout(()=> requestsRef.child(myViewerId).remove().catch(()=>{}), 60*1000);
}

/* ========== Viewer sending messages ========== */
sendMsg.onclick = () => {
  const text = msgInput.value.trim();
  if(!text) return;
  const name = nameInput.value.trim() || (localStorage.getItem('sulove_name') || 'Anonymous');
  const color = (name.toLowerCase() === 'admin') ? 'red' : (localStorage.getItem('sulove_color') || randomColor());
  pushChat(name, text, color);
  msgInput.value = '';
};

sendAdminMsg.onclick = () => {
  if(!isAdmin) return;
  const text = adminMsg.value.trim();
  if(!text) return;
  pushChat('Admin', text, 'red');
  adminMsg.value = '';
};

/* ========== Fullscreen ========= */
fullscreenBtn.onclick = () => {
  const v = remoteVideo;
  if(!v) return;
  if(v.requestFullscreen) v.requestFullscreen();
  else if(v.webkitRequestFullscreen) v.webkitRequestFullscreen();
};

/* ========== Presence cleanup and viewer list (optional) ========== */
const viewersListRef = db.ref('viewers');
viewersListRef.on('child_added', snap => {
  const val = snap.val();
  appendLocalSystem((val.name || 'Viewer') + ' joined');
});
viewersListRef.on('child_removed', snap => {
  const val = snap.val();
  if(val) appendLocalSystem((val.name || 'Viewer') + ' left');
});

/* ========== Edge: if viewer opens multiple tabs, avoid double counting ========== */
(function manageLocalJoinFlag(){
  const localFlagKey = 'sulove_live_joined';
  function joinOnce(){
    if(!sessionStorage.getItem(localFlagKey)){
      sessionStorage.setItem(localFlagKey, 'yes');
      // if we are viewer already (viewerId set) but just opened another tab, don't increment.
    }
  }
  joinOnce();
})();

/* ========== Final: broadcaster presence (no messages by default) ========== */
db.ref('meta/broadcaster').on('value', s => {
  const meta = s.val();
  if(!meta || !meta.online) {
    // broadcaster offline - we push a local system message (not to DB)
    // appendLocalSystem('System: no broadcaster online right now.');
  } else {
    // broadcaster online
  }
});
  </script>
</body>
</html>
