<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Sulove Live â€” Single File</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; background:#f4f6f8; color:#111; margin:0; padding:18px; display:flex; justify-content:center; }
    .wrap { width:100%; max-width:900px; }
    .card { background:#fff; border-radius:10px; padding:18px; box-shadow:0 6px 20px rgba(0,0,0,0.06); margin-bottom:12px; }
    h1,h2 { margin:6px 0 12px 0; font-weight:600; }
    .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    input[type=text], input[type=password], textarea { width:100%; padding:10px; border-radius:6px; border:1px solid #ddd; box-sizing:border-box; }
    button { background:#111; color:#fff; border:none; padding:10px 14px; border-radius:6px; cursor:pointer; }
    button.ghost { background:transparent; color:#111; border:1px solid #ddd; }
    video { width:100%; background:#000; border-radius:8px; display:block; margin-top:10px; }
    #chat { height:220px; overflow:auto; background:#fafafa; padding:8px; border-radius:6px; border:1px solid #eee; text-align:left; }
    .chat-msg { margin:6px 0; padding:6px; border-radius:6px; background:#fff; box-shadow:0 1px 0 rgba(0,0,0,.03); }
    .small { font-size:13px; color:#666; }
    .center { text-align:center; }
    .muted { color:#666; font-size:13px; }
    .controls { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    @media (max-width:600px){ .row{flex-direction:column;} .controls{flex-direction:column;} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card center">
      <h1>ðŸ”¥ Sulove Live Stream</h1>
      <p class="muted">Admin password protected. Admin can share PC or Android screen. Viewers enter a name and watch instantly.</p>
    </div>

    <!-- LOGIN / CHOICE -->
    <div class="card" id="entryCard">
      <h2>Enter</h2>
      <div class="row">
        <input id="nameInput" type="text" placeholder="If viewer: type your name here. If admin: leave blank and enter password below." />
        <input id="passwordInput" type="password" placeholder="Admin password (Sulove@123)" />
        <button id="enterBtn">Enter</button>
      </div>
      <p class="small">Correct admin password = Admin Panel. Otherwise you join as viewer.</p>
    </div>

    <!-- ADMIN PANEL -->
    <div class="card" id="adminCard" style="display:none;">
      <h2>Admin Panel</h2>
      <div class="row">
        <button id="startBtn">Start Screen Share</button>
        <button id="stopBtn" class="ghost">Stop Sharing</button>
        <button id="clearChatBtn" class="ghost">Clear Chat</button>
      </div>

      <div style="margin-top:10px;">
        <div class="small">Viewer Count: <strong id="viewerCountAdmin">0</strong></div>
      </div>

      <video id="localVideo" autoplay playsinline muted></video>

      <h3 style="margin-top:12px">Chat (Admin)</h3>
      <div id="chat" aria-live="polite"></div>

      <div class="row" style="margin-top:8px;">
        <input id="adminMsg" type="text" placeholder="Type message as Admin and press Send" />
        <button id="sendAdminMsg">Send</button>
      </div>
    </div>

    <!-- VIEWER PANEL -->
    <div class="card" id="viewerCard" style="display:none;">
      <h2>Viewer</h2>
      <div class="small">You are: <strong id="viewerNameLabel"></strong></div>
      <div style="margin-top:8px;">
        <video id="remoteVideo" autoplay playsinline controls></video>
      </div>
      <div class="controls">
        <button id="fullscreenBtn">Full Screen</button>
        <button id="leaveBtn" class="ghost">Leave</button>
      </div>
      <div style="margin-top:10px;">
        <div class="small">Viewer Count: <strong id="viewerCountViewer">0</strong></div>
      </div>

      <h3 style="margin-top:12px">Live Chat</h3>
      <div id="chat" aria-live="polite"></div>
      <div class="row" style="margin-top:8px;">
        <input id="msgInput" type="text" placeholder="Type message..." />
        <button id="sendMsg">Send</button>
      </div>
    </div>

    <div class="card small center" style="margin-top:10px;">
      <div>Built with Firebase Realtime DB as signalling (free). For Android APK, start the native screen capture service.</div>
    </div>
  </div>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
const firebaseConfig = {
  apiKey: "AIzaSyCG7g35KGyX9F9utI-lnkaViM7mQzWrO3A",
  authDomain: "livestreamproject-3f19c.firebaseapp.com",
  databaseURL: "https://livestreamproject-3f19c-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "livestreamproject-3f19c",
  storageBucket: "livestreamproject-3f19c.appspot.com",
  messagingSenderId: "639236892430",
  appId: "1:639236892430:web:c2a888d27759487d91d95f"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const ADMIN_PASSWORD = "Sulove@123";

/* ===== UI Refs ===== */
const entryCard = document.getElementById('entryCard');
const adminCard = document.getElementById('adminCard');
const viewerCard = document.getElementById('viewerCard');
const nameInput = document.getElementById('nameInput');
const passwordInput = document.getElementById('passwordInput');
const enterBtn = document.getElementById('enterBtn');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const localVideo = document.getElementById('localVideo');
const remoteVideo = document.getElementById('remoteVideo');
const viewerNameLabel = document.getElementById('viewerNameLabel');
const viewerCountAdmin = document.getElementById('viewerCountAdmin');
const viewerCountViewer = document.getElementById('viewerCountViewer');
const chatBox = document.querySelectorAll('#chat')[0];
const adminMsg = document.getElementById('adminMsg');
const sendAdminMsg = document.getElementById('sendAdminMsg');
const msgInput = document.getElementById('msgInput');
const sendMsg = document.getElementById('sendMsg');
const clearChatBtn = document.getElementById('clearChatBtn');
const fullscreenBtn = document.getElementById('fullscreenBtn');

let isAdmin = false;
let localStream = null;
let pcs = {};
let viewerId = null;

function genId(len=8){ const s='abcdefghijklmnopqrstuvwxyz0123456789'; return Array.from({length:len},()=>s[Math.floor(Math.random()*s.length)]).join(''); }
function now(){ return new Date().toISOString(); }
function appendChat(text){ const div=document.createElement('div'); div.className='chat-msg'; div.innerText=text; chatBox.appendChild(div); chatBox.scrollTop=chatBox.scrollHeight; }

const viewerCountRef = db.ref('meta/viewerCount');
viewerCountRef.once('value', snap => { if(snap.val()===null) viewerCountRef.set(0); });
viewerCountRef.on('value', snap => {
  const v = snap.val() || 0;
  viewerCountAdmin.innerText = v;
  viewerCountViewer.innerText = v;
});
async function incViewerCount(){ await viewerCountRef.transaction(n => (n||0)+1); }
async function decViewerCount(){ await viewerCountRef.transaction(n => Math.max(0,(n||0)-1)); }

window.addEventListener('beforeunload', () => {
  if(!isAdmin && viewerId) { decViewerCount(); db.ref('viewers/'+viewerId).remove().catch(()=>{}); }
});

/* ===== Chat ===== */
const chatRef = db.ref('chat');
chatRef.on('child_added', snap => { appendChat(snap.val().time + '  ' + snap.val().text); });
function pushChat(name,text){ chatRef.push({time:now(),text:`${name}: ${text}`}); }
clearChatBtn.onclick = ()=>{ if(!isAdmin) return; db.ref('chat').remove(); chatBox.innerHTML=''; };

/* ===== Entry ===== */
enterBtn.onclick = ()=>{
  const pass=passwordInput.value.trim();
  const name=nameInput.value.trim();
  if(pass===ADMIN_PASSWORD){
    isAdmin=true; entryCard.style.display='none'; adminCard.style.display='block'; viewerCard.style.display='none';
    appendChat('System: Admin signed in at '+now());
    listenForViewerRequests();
  }else{
    isAdmin=false;
    viewerId=genId(10); entryCard.style.display='none'; adminCard.style.display='none'; viewerCard.style.display='block';
    viewerNameLabel.innerText=name||'Anonymous';
    db.ref('viewers/'+viewerId).set({name:name||'Anonymous',joined:now()});
    incViewerCount();
    requestOfferAsViewer(viewerId,name||'Anonymous');
    appendChat('System: Viewer joined as '+(name||'Anonymous')+' at '+now());
  }
};

/* ===== Admin start/stop share (fixed) ===== */
startBtn.onclick = async ()=>{
  if(!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia){
    alert('Screen capture not supported in this APK WebView. Use Android native screen capture service.');
    return;
  }
  try{
    localStream = await navigator.mediaDevices.getDisplayMedia({video:true,audio:true});
    localVideo.srcObject=localStream;
    appendChat('Admin: started sharing at '+now());
    db.ref('meta/broadcaster').set({online:true,startedAt:now()});
  }catch(e){ alert('Could not getDisplayMedia(): '+e.message); console.error(e); }
};
stopBtn.onclick=()=>{
  if(localStream){ localStream.getTracks().forEach(t=>t.stop()); localStream=null; localVideo.srcObject=null; }
  db.ref('meta/broadcaster').set({online:false,stoppedAt:now()});
  appendChat('Admin: stopped sharing at '+now());
};

fullscreenBtn.onclick=()=>{ if(remoteVideo.requestFullscreen) remoteVideo.requestFullscreen(); else if(remoteVideo.webkitRequestFullscreen) remoteVideo.webkitRequestFullscreen(); };

/* ===== Viewer / Admin messaging ===== */
sendMsg.onclick=()=>{ const text=msgInput.value.trim(); if(!text) return; pushChat(nameInput.value||'Anonymous',text); msgInput.value=''; };
sendAdminMsg.onclick=()=>{ if(!isAdmin) return; const text=adminMsg.value.trim(); if(!text) return; pushChat('Admin',text); adminMsg.value=''; };

/* ===== Optional presence / viewer join/leave messages ===== */
const viewersListRef=db.ref('viewers');
viewersListRef.on('child_added',snap=>{ const val=snap.val(); appendChat('System: '+(val.name||'Viewer')+' joined at '+(val.joined||now())); });
viewersListRef.on('child_removed',snap=>{ const val=snap.val(); if(val) appendChat('System: '+(val.name||'Viewer')+' left'); });

/* ===== Placeholder for your existing WebRTC code (listenForViewerRequests, requestOfferAsViewer) ===== */
/* Copy all your previous WebRTC logic here, unchanged. */

  </script>
</body>
</html>
