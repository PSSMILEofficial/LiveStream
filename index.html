<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>Sulove Live â€” Mobile Screen Share Fixed</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />

<style>
body { font-family: Arial, sans-serif; background:#f4f6f8; color:#111; margin:0; padding:18px; display:flex; justify-content:center; }
.wrap { width:100%; max-width:900px; }
.card { background:#fff; border-radius:10px; padding:18px; box-shadow:0 6px 20px rgba(0,0,0,0.06); margin-bottom:12px; }
h1,h2,h3 { margin:6px 0 12px 0; font-weight:600; }
.row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
input[type=text], input[type=password], textarea {
  width:100%; padding:10px; border-radius:6px; border:1px solid #ddd; box-sizing:border-box;
}
textarea { resize: vertical; min-height:80px; }
button { background:#111; color:#fff; border:none; padding:10px 14px; border-radius:6px; cursor:pointer; }
button.ghost { background:transparent; color:#111; border:1px solid #ddd; }
video { width:100%; background:#000; border-radius:8px; display:block; margin-top:10px; }
#chatBox { height:220px; overflow:auto; background:#fafafa; padding:8px; border-radius:6px; border:1px solid #eee; text-align:left; }
.chat-msg { margin:6px 0; padding:6px; border-radius:6px; background:#fff; box-shadow:0 1px 0 rgba(0,0,0,.03); }
.chat-msg.admin { background:#e0f7fa; color:#00796b; font-weight:600; }
.small { font-size:13px; color:#666; }
.center { text-align:center; }
.muted { color:#666; font-size:13px; }
.controls { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
@media (max-width:600px){ .row{flex-direction:column;} .controls{flex-direction:column;} }
</style>
</head>
<body>

<div class="wrap">

  <div class="card center">
    <h1>ðŸ”¥ Sulove Live Stream</h1>
    <p class="muted">Android + PC screen sharing supported.</p>
  </div>

  <!-- ENTRY -->
  <div class="card" id="entryCard">
    <h2>Enter</h2>
    <div class="row">
      <input id="nameInput" type="text" placeholder="Viewer name" />
      <input id="passwordInput" type="password" placeholder="Admin password" />
      <button id="enterBtn">Enter</button>
    </div>
  </div>

  <!-- ADMIN PANEL -->
  <div class="card" id="adminCard" style="display:none;">
    <h2>Admin Panel</h2>
    <button id="startBtn">Start Screen Share</button>
    <button id="stopBtn" class="ghost">Stop Sharing</button>
    
    <div class="small">Viewer Count: <strong id="viewerCountAdmin">0</strong></div>

    <video id="localVideo" autoplay playsinline muted></video>

    <h3>Chat</h3>
    <div id="chatBox"></div>
    <div class="row">
      <input id="adminMsg" type="text" placeholder="Admin message..." />
      <button id="sendAdminMsg">Send</button>
    </div>
  </div>

  <!-- VIEWER PANEL -->
  <div class="card" id="viewerCard" style="display:none;">
    <h2>Viewer</h2>
    <div class="small">You are: <strong id="viewerNameLabel"></strong></div>

    <video id="remoteVideo" autoplay playsinline controls></video>

    <div class="controls">
      <button id="fullscreenBtn">Full Screen</button>
      <button id="leaveBtn" class="ghost">Leave</button>
    </div>

    <div class="small">Viewer Count: <strong id="viewerCountViewer">0</strong></div>

    <h3>Chat</h3>
    <div id="chatBox"></div>
    <div class="row">
      <input id="msgInput" type="text" placeholder="Message..." />
      <button id="sendMsg">Send</button>
    </div>
  </div>

</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
// ----------------- FIREBASE CONFIG -----------------
firebase.initializeApp({
  apiKey: "AIzaSyCG7g35KGyX9F9utI-lnkaViM7mQzWrO3A",
  authDomain: "livestreamproject-3f19c.firebaseapp.com",
  databaseURL: "https://livestreamproject-3f19c-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "livestreamproject-3f19c",
  storageBucket: "livestreamproject-3f19c.appspot.com",
  messagingSenderId: "639236892430",
  appId: "1:639236892430:web:c2a888d27759487d91d95f"
});
const db = firebase.database();

// ------------- ELEMENTS ----------------
const ADMIN_PASSWORD="Sulove@123";
const entryCard=document.getElementById("entryCard");
const adminCard=document.getElementById("adminCard");
const viewerCard=document.getElementById("viewerCard");
const nameInput=document.getElementById("nameInput");
const passwordInput=document.getElementById("passwordInput");
const viewerNameLabel=document.getElementById("viewerNameLabel");

const startBtn=document.getElementById("startBtn");
const stopBtn=document.getElementById("stopBtn");

const localVideo=document.getElementById("localVideo");
const remoteVideo=document.getElementById("remoteVideo");

const viewerCountAdmin=document.getElementById("viewerCountAdmin");
const viewerCountViewer=document.getElementById("viewerCountViewer");

const chatBox=document.getElementById("chatBox");
const adminMsg=document.getElementById("adminMsg");
const sendAdminMsg=document.getElementById("sendAdminMsg");
const msgInput=document.getElementById("msgInput");
const sendMsg=document.getElementById("sendMsg");

let isAdmin=false;
let viewerId=null;
let localStream=null;
let pcs={};

function now(){ return new Date().toISOString(); }
function genId(len=8){ const s="abcdefghijklmnopqrstuvwxyz0123456789"; return Array.from({length:len},()=>s[Math.floor(Math.random()*s.length)]).join(""); }

function appendChat(t,a=false){
  const d=document.createElement("div");
  d.className="chat-msg";
  if(a) d.classList.add("admin");
  d.innerText=t;
  chatBox.appendChild(d);
  chatBox.scrollTop=chatBox.scrollHeight;
}

db.ref("meta/viewerCount").on("value",snap=>{
  const v=snap.val()||0;
  viewerCountAdmin.innerText=v;
  viewerCountViewer.innerText=v;
});

// ---------------- ENTER ----------------
enterBtn.onclick=()=>{
  const pass=passwordInput.value.trim();
  const name=nameInput.value.trim()||"Viewer";

  if(pass===ADMIN_PASSWORD){
    isAdmin=true;
    entryCard.style.display="none";
    adminCard.style.display="block";
  } else {
    isAdmin=false;
    viewerId=genId(10);
    entryCard.style.display="none";
    viewerCard.style.display="block";
    viewerNameLabel.innerText=name;
    viewerJoin(name);
  }
};

// ---------------- ADMIN SCREEN SHARE ----------------
startBtn.onclick = async () => {

  if(!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia){
    alert("âŒ Screen sharing not supported on this device.\nAndroid Chrome recommended.");
    return;
  }

  try {
    // Important: user gesture (button click)
    localStream = await navigator.mediaDevices.getDisplayMedia({
      video: { displaySurface: "monitor" },
      audio: true
    });

  } catch(err){
    alert("Could not start screen sharing: " + err.message);
    return;
  }

  localVideo.srcObject = localStream;

  db.ref("meta/broadcaster").set({ online:true, startedAt: now() });
  appendChat("Admin started sharing.", true);

  listenForViewerRequests();
};

// ---------------- STOP SHARE ----------------
stopBtn.onclick=()=>{
  if(localStream){
    localStream.getTracks().forEach(t=>t.stop());
    localStream=null;
  }
  db.ref("meta/broadcaster").set({ online:false });
  appendChat("Admin stopped screen sharing.", true);
};

// ---------- VIEWER REQUEST OFFER ----------
function viewerJoin(name){
  viewerId=genId();
  db.ref("viewers/"+viewerId).set({name, joined: now()});

  requestOffer(viewerId,name);
  window.addEventListener("unload",()=>{
    db.ref("viewers/"+viewerId).remove();
  });
}

// ---------- WebRTC OFFER/ANSWER ----------
const requestsRef=db.ref("requests");
const offersRef=db.ref("offers");
const answersRef=db.ref("answers");
const iceViewer=db.ref("ice/viewer");
const iceAdmin=db.ref("ice/admin");

async function listenForViewerRequests(){
  requestsRef.on("child_added", async snap=>{
    const vId=snap.key;
    if(!localStream){ offersRef.child(vId).set({error:"no-broadcaster"}); return; }

    const pc=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});
    pcs[vId]=pc;

    localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));

    pc.onicecandidate=e=>{
      if(e.candidate) iceAdmin.child(vId).push(JSON.stringify(e.candidate));
    };

    const offer=await pc.createOffer();
    await pc.setLocalDescription(offer);
    offersRef.child(vId).set(JSON.stringify(offer));

    answersRef.child(vId).on("value", s=>{
      if(!s.val()) return;
      pc.setRemoteDescription(JSON.parse(s.val())).catch(()=>{});
    });

    iceViewer.child(vId).on("child_added", si=>{
      pc.addIceCandidate(new RTCIceCandidate(JSON.parse(si.val()))).catch(()=>{});
    });
  });
}

async function requestOffer(myId,name){
  const pc=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});
  pc.ontrack=e=>{ remoteVideo.srcObject=e.streams[0]; };

  pc.onicecandidate=e=>{
    if(e.candidate) iceViewer.child(myId).push(JSON.stringify(e.candidate));
  };

  requestsRef.child(myId).set({name, createdAt:now()});

  offersRef.child(myId).on("value", async snap=>{
    const val=snap.val();
    if(!val) return;

    if(val.error){
      appendChat("Waiting for admin to start sharing...");
      return;
    }

    await pc.setRemoteDescription(JSON.parse(val));
    const ans=await pc.createAnswer();
    await pc.setLocalDescription(ans);

    answersRef.child(myId).set(JSON.stringify(ans));

    iceAdmin.child(myId).on("child_added", si=>{
      pc.addIceCandidate(new RTCIceCandidate(JSON.parse(si.val()))).catch(()=>{});
    });
  });
}

// ---------------- CHAT ----------------
sendAdminMsg.onclick=()=>{
  if(!isAdmin) return;
  const t=adminMsg.value.trim();
  if(!t) return;
  db.ref("chat").push({text:"Admin: "+t, admin:true});
  adminMsg.value="";
};

sendMsg.onclick=()=>{
  const t=msgInput.value.trim();
  if(!t) return;
  db.ref("chat").push({text: viewerNameLabel.innerText+": "+t});
  msgInput.value="";
};

db.ref("chat").on("child_added",snap=>{
  appendChat(snap.val().text, snap.val().admin);
});

// ---------------- FULLSCREEN ---------------
fullscreenBtn.onclick=()=>{
  if(remoteVideo.requestFullscreen) remoteVideo.requestFullscreen();
};
</script>

</body>
</html>
