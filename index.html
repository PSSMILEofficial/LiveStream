<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>Sulove Classic Live</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<style>
  body { font-family: Georgia, serif; background:#e6e6e6; color:#111; margin:0; padding:20px; display:flex; justify-content:center; }
  .wrap { width:100%; max-width:800px; }
  .card { background:#fff; border-radius:6px; padding:16px; box-shadow:0 4px 10px rgba(0,0,0,0.08); margin-bottom:12px; }
  h1,h2 { margin:6px 0 12px 0; font-weight:600; }
  input[type=text] { width:100%; padding:8px; border-radius:4px; border:1px solid #ccc; box-sizing:border-box; }
  button { background:#333; color:#fff; border:none; padding:8px 12px; border-radius:4px; cursor:pointer; font-weight:bold; }
  button.ghost { background:transparent; color:#333; border:1px solid #aaa; }
  video { width:100%; background:#000; border-radius:4px; display:block; margin-top:10px; }
  #chat { height:200px; overflow:auto; background:#fafafa; padding:8px; border-radius:4px; border:1px solid #ddd; font-family:monospace; font-size:14px; }
  .chat-msg { margin:4px 0; padding:4px 6px; border-radius:4px; background:#f0f0f0; }
  .small { font-size:13px; color:#555; }
  .center { text-align:center; }
  .controls { display:flex; gap:6px; flex-wrap:wrap; margin-top:8px; }
  @media (max-width:600px){ .controls{flex-direction:column;} }
</style>
</head>
<body>
<div class="wrap">

  <div class="card center">
    <h1>ðŸ”¥ Sulove Classic Live</h1>
    <p class="small">Admin can share screen. Viewers join instantly with a name. Classic live stream experience.</p>
  </div>

  <!-- ENTRY CARD -->
  <div class="card" id="entryCard">
    <h2>Enter Your Name</h2>
    <div class="controls">
      <input id="nameInput" type="text" placeholder="Type your name..." />
      <button id="enterBtn">Join</button>
    </div>
  </div>

  <!-- ADMIN PANEL -->
  <div class="card" id="adminCard" style="display:none;">
    <h2>Admin Panel</h2>
    <div class="controls">
      <button id="startBtn">Start Screen Share</button>
      <button id="stopBtn" class="ghost">Stop Sharing</button>
      <button id="clearChatBtn" class="ghost">Clear Chat</button>
    </div>
    <div class="small" style="margin-top:8px;">Live Viewers: <strong id="viewerCountAdmin">0</strong></div>
    <video id="localVideo" autoplay playsinline muted></video>

    <h3 style="margin-top:12px;">Chat</h3>
    <div id="chatAdmin"></div>
    <div class="controls" style="margin-top:6px;">
      <input id="adminMsg" type="text" placeholder="Type message..." />
      <button id="sendAdminMsg">Send</button>
    </div>
  </div>

  <!-- VIEWER PANEL -->
  <div class="card" id="viewerCard" style="display:none;">
    <h2>Viewer</h2>
    <div class="small">You are: <strong id="viewerNameLabel"></strong></div>
    <video id="remoteVideo" autoplay playsinline controls></video>
    <div class="controls">
      <button id="fullscreenBtn">Full Screen</button>
      <button id="leaveBtn" class="ghost">Leave</button>
    </div>
    <div class="small" style="margin-top:8px;">Live Viewers: <strong id="viewerCountViewer">0</strong></div>

    <h3 style="margin-top:12px;">Chat</h3>
    <div id="chatViewer"></div>
    <div class="controls" style="margin-top:6px;">
      <input id="msgInput" type="text" placeholder="Type message..." />
      <button id="sendMsg">Send</button>
    </div>
  </div>

</div>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
// ===== Firebase Setup =====
const firebaseConfig = {
  apiKey: "AIzaSyCG7g35KGyX9F9utI-lnkaViM7mQzWrO3A",
  authDomain: "livestreamproject-3f19c.firebaseapp.com",
  databaseURL: "https://livestreamproject-3f19c-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "livestreamproject-3f19c",
  storageBucket: "livestreamproject-3f19c.appspot.com",
  messagingSenderId: "639236892430",
  appId: "1:639236892430:web:c2a888d27759487d91d95f"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ===== UI References =====
const entryCard = document.getElementById('entryCard');
const adminCard = document.getElementById('adminCard');
const viewerCard = document.getElementById('viewerCard');
const nameInput = document.getElementById('nameInput');
const enterBtn = document.getElementById('enterBtn');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const localVideo = document.getElementById('localVideo');
const remoteVideo = document.getElementById('remoteVideo');
const viewerNameLabel = document.getElementById('viewerNameLabel');
const viewerCountAdmin = document.getElementById('viewerCountAdmin');
const viewerCountViewer = document.getElementById('viewerCountViewer');
const chatAdmin = document.getElementById('chatAdmin');
const chatViewer = document.getElementById('chatViewer');
const adminMsg = document.getElementById('adminMsg');
const sendAdminMsg = document.getElementById('sendAdminMsg');
const msgInput = document.getElementById('msgInput');
const sendMsg = document.getElementById('sendMsg');
const clearChatBtn = document.getElementById('clearChatBtn');
const fullscreenBtn = document.getElementById('fullscreenBtn');
const leaveBtn = document.getElementById('leaveBtn');

let isAdmin = false;
let localStream = null;
let viewerId = null;

// ===== Utils =====
function genId(len=10){ const s='abcdefghijklmnopqrstuvwxyz0123456789'; return Array.from({length:len},()=>s[Math.floor(Math.random()*s.length)]).join(''); }
function now(){ return new Date().toLocaleTimeString(); }
function appendChat(msg, admin=false){
  const div = document.createElement('div');
  div.className = 'chat-msg';
  div.textContent = msg;
  chatAdmin.appendChild(div);
  chatViewer.appendChild(div);
  chatAdmin.scrollTop = chatAdmin.scrollHeight;
  chatViewer.scrollTop = chatViewer.scrollHeight;
}

// ===== Viewer Count =====
const viewerCountRef = db.ref('meta/viewerCount');
viewerCountRef.once('value', snap=>{ if(snap.val()===null) viewerCountRef.set(0); });
viewerCountRef.on('value', snap=>{
  const v = snap.val() || 0;
  viewerCountAdmin.innerText = v;
  viewerCountViewer.innerText = v;
});
async function incViewerCount(){ await viewerCountRef.transaction(n => (n||0)+1); }
async function decViewerCount(){ await viewerCountRef.transaction(n => Math.max(0,(n||0)-1)); }

// ===== Chat =====
const chatRef = db.ref('chat');
chatRef.on('child_added', snap=>{ const val = snap.val(); appendChat(val.text, val.admin); });
function pushChat(text, admin=false){ chatRef.push({text,admin}); }
clearChatBtn.onclick = ()=>{ if(!isAdmin) return; db.ref('chat').remove(); chatAdmin.innerHTML=''; chatViewer.innerHTML=''; };

// ===== Entry =====
enterBtn.onclick = ()=>{
  const name = nameInput.value.trim() || 'Anonymous';
  if(name.toLowerCase() === 'admin'){ // Admin login
    isAdmin = true;
    entryCard.style.display='none';
    adminCard.style.display='block';
    viewerCard.style.display='none';
    appendChat('System: Admin joined', true);
  }else{
    isAdmin = false;
    viewerId = genId(10);
    entryCard.style.display='none';
    adminCard.style.display='none';
    viewerCard.style.display='block';
    viewerNameLabel.innerText = name;
    db.ref('viewers/'+viewerId).set({joined:now()});
    incViewerCount();
    appendChat('System: '+name+' joined');
  }
};

// ===== Admin Screen Share =====
startBtn.onclick = async ()=>{
  try{
    localStream = await navigator.mediaDevices.getDisplayMedia({video:true,audio:true});
    localVideo.srcObject = localStream;
    appendChat('Admin: started sharing', true);
    db.ref('meta/broadcaster').set({online:true});
  }catch(e){ alert('Screen capture not supported: '+e.message); }
};
stopBtn.onclick = ()=>{
  if(localStream){ localStream.getTracks().forEach(t=>t.stop()); localStream=null; localVideo.srcObject=null; }
  db.ref('meta/broadcaster').set({online:false});
  appendChat('Admin: stopped sharing', true);
};

// ===== Messaging =====
sendMsg.onclick = ()=>{ const text=msgInput.value.trim(); if(!text) return; pushChat('Viewer: '+text); msgInput.value=''; };
sendAdminMsg.onclick = ()=>{ if(!isAdmin) return; const text=adminMsg.value.trim(); if(!text) return; pushChat('Admin: '+text, true); adminMsg.value=''; };

// ===== Fullscreen & Leave =====
fullscreenBtn.onclick = ()=>{ if(remoteVideo.requestFullscreen) remoteVideo.requestFullscreen(); else if(remoteVideo.webkitRequestFullscreen) remoteVideo.webkitRequestFullscreen(); };
leaveBtn.onclick = ()=>{
  if(viewerId){ decViewerCount(); db.ref('viewers/'+viewerId).remove(); }
  location.reload();
};

// ===== Cleanup =====
window.addEventListener('beforeunload', ()=>{
  if(!isAdmin && viewerId){ decViewerCount(); db.ref('viewers/'+viewerId).remove(); }
});

// ===== WebRTC logic placeholder =====
// Implement your listenForViewerRequests & requestOfferAsViewer logic here.

</script>
</body>
</html>
