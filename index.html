<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>FreeLive</title>
<style>
body{font-family:Arial,sans-serif; background:#111; color:#eee; text-align:center; padding:20px;}
button{padding:10px 15px; margin:6px; cursor:pointer;}
input{padding:8px; width:220px;}
video{width:90%; max-width:1000px; background:#000; border:2px solid #333; margin-top:12px;}
#roomInfo,#viewers{font-size:13px;color:#9df; margin-top:8px;}
</style>

<!-- Firebase Compat SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

</head>
<body>
<h1>FreeLive — Broadcast your screen</h1>

<div>
<button id="startBroadcast">Start Broadcast</button>
<button id="stopBroadcast" style="display:none;">Stop Broadcast</button><br>
<input id="roomInput" placeholder="Enter Room ID to join">
<button id="joinBtn">Join as Viewer</button>
<p id="roomInfo"></p>
<p id="viewers"></p>
</div>

<video id="localVideo" autoplay muted playsinline></video>
<video id="remoteVideo" autoplay playsinline style="display:none;"></video>

<script>
  // ===== Your Firebase Config =====
  const firebaseConfig = {
    apiKey: "AIzaSyBAVVKS0V3TY0R26M6mstewZHaJydsydfg",
    authDomain: "freelive-19807.firebaseapp.com",
    databaseURL: "https://freelive-19807-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "freelive-19807",
    storageBucket: "freelive-19807.firebasestorage.app",
    messagingSenderId: "262588703828",
    appId: "1:262588703828:web:98f0fc7946b626243279c1"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const $ = id=>document.getElementById(id);
  let isBroadcaster=false;
  let localStream=null;
  let myRoomId=null;
  let viewerPCs={};
  const rtcConfig={iceServers:[{urls:"stun:stun.l.google.com:19302"}]};

  function randomId(len=7){return Math.random().toString(36).slice(2,2+len);}
  function updateViewers(){ $('viewers').innerText=`Connected viewers: ${Object.keys(viewerPCs).length}`; }

  async function stopBroadcast(){
    Object.keys(viewerPCs).forEach(id=>{
      try{viewerPCs[id].pc.close();}catch(e){}
      try{viewerPCs[id].vCandRef.off();}catch(e){}
    });
    viewerPCs={};
    if(localStream){localStream.getTracks().forEach(t=>t.stop()); localStream=null;}
    localVideo.srcObject=null;
    $('startBroadcast').style.display='inline-block';
    $('stopBroadcast').style.display='none';
    if(myRoomId) db.ref(`rooms/${myRoomId}`).remove().catch(()=>{});
    $('roomInfo').innerText='';
    updateViewers();
  }

  $('startBroadcast').onclick=async ()=>{
    isBroadcaster=true;
    try{
      localStream=await navigator.mediaDevices.getDisplayMedia({video:{frameRate:20}, audio:true});
    }catch(e){
      localStream=await navigator.mediaDevices.getUserMedia({video:{frameRate:20}, audio:true});
    }
    localVideo.srcObject=localStream;
    $('startBroadcast').style.display='none';
    $('stopBroadcast').style.display='inline-block';
    myRoomId=randomId(8);
    $('roomInfo').innerHTML=`Room ID: <strong>${myRoomId}</strong> — share with viewers.`;
    await db.ref(`rooms/${myRoomId}`).set({createdAt:Date.now(), broadcaster:true});
    const offersRef=db.ref(`rooms/${myRoomId}/offers`);
    offersRef.on('child_added', async snap=>{
      const viewerId=snap.key;
      const offer=snap.val();
      if(!offer || viewerPCs[viewerId]) return;
      const pc=new RTCPeerConnection(rtcConfig);
      localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
      pc.onicecandidate=event=>{
        if(event.candidate)
          db.ref(`rooms/${myRoomId}/broadcasterCandidates/${viewerId}`).push().set(event.candidate.toJSON()).catch(console.error);
      };
      try{await pc.setRemoteDescription(new RTCSessionDescription(offer));}catch(e){console.error(e);}
      const answer=await pc.createAnswer();
      await pc.setLocalDescription(answer);
      await db.ref(`rooms/${myRoomId}/answers/${viewerId}`).set(pc.localDescription.toJSON());
      const vCandRef=db.ref(`rooms/${myRoomId}/viewerCandidates/${viewerId}`);
      vCandRef.on('child_added', snapc=>{
        const c=snapc.val();
        if(c) pc.addIceCandidate(new RTCIceCandidate(c)).catch(console.error);
      });
      viewerPCs[viewerId]={pc,vCandRef};
      updateViewers();
    });
    localStream.getTracks().forEach(t=>t.onended=()=>stopBroadcast());
  };

  $('stopBroadcast').onclick=stopBroadcast;

  $('joinBtn').onclick=async ()=>{
    isBroadcaster=false;
    const roomId=$('roomInput').value.trim();
    if(!roomId){alert('Enter Room ID.'); return;}
    const roomSnapshot=await db.ref(`rooms/${roomId}`).get();
    if(!roomSnapshot.exists()){alert('Room not found.'); return;}
    const viewerId=randomId(9);
    const pc=new RTCPeerConnection(rtcConfig);
    pc.ontrack=e=>{
      $('remoteVideo').style.display='block';
      $('remoteVideo').srcObject=e.streams[0];
    };
    pc.onicecandidate=event=>{
      if(event.candidate)
        db.ref(`rooms/${roomId}/viewerCandidates/${viewerId}`).push().set(event.candidate.toJSON()).catch(console.error);
    };
    const offer=await pc.createOffer();
    await pc.setLocalDescription(offer);
    await db.ref(`rooms/${roomId}/offers/${viewerId}`).set(pc.localDescription.toJSON());
    const answerRef=db.ref(`rooms/${roomId}/answers/${viewerId}`);
    answerRef.on('value', async snap=>{
      const ans=snap.val();
      if(ans) await pc.setRemoteDescription(new RTCSessionDescription(ans)).catch(console.error);
    });
    const bCandRef=db.ref(`rooms/${roomId}/broadcasterCandidates/${viewerId}`);
    bCandRef.on('child_added', snap=>{
      const c=snap.val();
      if(c) pc.addIceCandidate(new RTCIceCandidate(c)).catch(console.error);
    });
    $('roomInfo').innerText=`Joined room ${roomId} as viewer ${viewerId}.`;
  };
</script>
</body>
</html>
