<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>Sulove Live â€” Upgraded Mobile & PC</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
body { font-family: Arial, sans-serif; background:#f4f6f8; color:#111; margin:0; padding:18px; display:flex; justify-content:center; }
.wrap { width:100%; max-width:900px; }
.card { background:#fff; border-radius:10px; padding:18px; box-shadow:0 6px 20px rgba(0,0,0,0.06); margin-bottom:12px; }
h1,h2,h3 { margin:6px 0 12px 0; font-weight:600; }
.row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
input[type=text], input[type=password], textarea { width:100%; padding:10px; border-radius:6px; border:1px solid #ddd; box-sizing:border-box; }
button { background:#111; color:#fff; border:none; padding:10px 14px; border-radius:6px; cursor:pointer; }
button.ghost { background:transparent; color:#111; border:1px solid #ddd; }
video { width:100%; background:#000; border-radius:8px; display:block; margin-top:10px; }
#chat { height:220px; overflow:auto; background:#fafafa; padding:8px; border-radius:6px; border:1px solid #eee; text-align:left; }
.chat-msg { margin:6px 0; padding:6px; border-radius:6px; background:#fff; box-shadow:0 1px 0 rgba(0,0,0,.03); }
.small { font-size:13px; color:#666; }
.center { text-align:center; }
.muted { color:#666; font-size:13px; }
.controls { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
#viewersList { margin-top:10px; padding:6px; border:1px solid #eee; border-radius:6px; background:#f9f9f9; max-height:150px; overflow:auto; }
@media (max-width:600px){ .row{flex-direction:column;} .controls{flex-direction:column;} #chat{height:150px;} }
</style>
</head>
<body>
<div class="wrap">
  <div class="card center">
    <h1>ðŸ”¥ Sulove Live Stream (Upgraded)</h1>
    <p class="muted">Admin password protected. Admin can share PC or Android screen. Viewers enter a name and watch instantly. iOS cannot act as Admin.</p>
  </div>

  <!-- ENTRY CARD -->
  <div class="card" id="entryCard">
    <h2>Enter</h2>
    <div class="row">
      <input id="nameInput" type="text" placeholder="Viewer: your name. Admin: leave blank + password." />
      <input id="passwordInput" type="password" placeholder="Admin password" />
      <button id="enterBtn">Enter</button>
    </div>
    <p class="small">Correct password â†’ Admin panel. Otherwise â†’ Viewer panel.</p>
  </div>

  <!-- ADMIN PANEL -->
  <div class="card" id="adminCard" style="display:none;">
    <h2>Admin Panel</h2>
    <div class="row">
      <button id="startBtn">Start Screen Share</button>
      <button id="stopBtn" class="ghost">Stop Sharing</button>
      <button id="clearChatBtn" class="ghost">Clear Chat</button>
    </div>
    <div style="margin-top:10px;">
      <div class="small">Viewer Count: <strong id="viewerCountAdmin">0</strong></div>
      <div id="viewersList"></div>
    </div>
    <video id="localVideo" autoplay playsinline muted></video>
    <h3 style="margin-top:12px">Chat (Admin)</h3>
    <div id="chat" aria-live="polite"></div>
    <div class="row" style="margin-top:8px;">
      <input id="adminMsg" type="text" placeholder="Type message as Admin and press Send" />
      <button id="sendAdminMsg">Send</button>
    </div>
  </div>

  <!-- VIEWER PANEL -->
  <div class="card" id="viewerCard" style="display:none;">
    <h2>Viewer</h2>
    <div class="small">You are: <strong id="viewerNameLabel"></strong></div>
    <div style="margin-top:8px;">
      <video id="remoteVideo" autoplay playsinline controls></video>
    </div>
    <div class="controls">
      <button id="fullscreenBtn">Full Screen</button>
      <button id="leaveBtn" class="ghost">Leave</button>
    </div>
    <div style="margin-top:10px;">
      <div class="small">Viewer Count: <strong id="viewerCountViewer">0</strong></div>
    </div>
    <h3 style="margin-top:12px">Live Chat</h3>
    <div id="chat" aria-live="polite"></div>
    <div class="row" style="margin-top:8px;">
      <input id="msgInput" type="text" placeholder="Type message..." />
      <button id="sendMsg">Send</button>
    </div>
  </div>

  <div class="card small center" style="margin-top:10px;">
    Built with Firebase Realtime DB as signalling (free). iOS requires native ReplayKit app.
  </div>
</div>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
/* ================= FIREBASE CONFIG ================= */
const firebaseConfig = {
  apiKey: "AIzaSyCG7g35KGyX9F9utI-lnkaViM7mQzWrO3A",
  authDomain: "livestreamproject-3f19c.firebaseapp.com",
  databaseURL: "https://livestreamproject-3f19c-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "livestreamproject-3f19c",
  storageBucket: "livestreamproject-3f19c.appspot.com",
  messagingSenderId: "639236892430",
  appId: "1:639236892430:web:c2a888d27759487d91d95f"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ================= CONSTANTS & UI ================= */
const ADMIN_PASSWORD = "Sulove@123";
const entryCard = document.getElementById('entryCard');
const adminCard = document.getElementById('adminCard');
const viewerCard = document.getElementById('viewerCard');
const nameInput = document.getElementById('nameInput');
const passwordInput = document.getElementById('passwordInput');
const enterBtn = document.getElementById('enterBtn');
const startBtn = document.getElementById('startBtn');
const stopBtn = document.getElementById('stopBtn');
const clearChatBtn = document.getElementById('clearChatBtn');
const localVideo = document.getElementById('localVideo');
const remoteVideo = document.getElementById('remoteVideo');
const viewerCountAdmin = document.getElementById('viewerCountAdmin');
const viewerCountViewer = document.getElementById('viewerCountViewer');
const viewerNameLabel = document.getElementById('viewerNameLabel');
const chatBoxes = document.querySelectorAll('#chat');
const adminMsg = document.getElementById('adminMsg');
const sendAdminMsg = document.getElementById('sendAdminMsg');
const msgInput = document.getElementById('msgInput');
const sendMsg = document.getElementById('sendMsg');
const fullscreenBtn = document.getElementById('fullscreenBtn');
const leaveBtn = document.getElementById('leaveBtn');
const viewersListEl = document.getElementById('viewersList');

let isAdmin = false;
let localStream = null;
let pcs = {};
let viewerId = null;

/* ================= UTILS ================= */
function now(){ return new Date().toISOString(); }
function genId(len=8){ const s='abcdefghijklmnopqrstuvwxyz0123456789'; return Array.from({length:len},()=>s[Math.floor(Math.random()*s.length)]).join(''); }
function appendChat(text){ chatBoxes.forEach(cb=>{ const d=document.createElement('div'); d.className='chat-msg'; d.innerText=text; cb.appendChild(d); cb.scrollTop=cb.scrollHeight; }); }
function isMobile(){ return /Mobi|Android/i.test(navigator.userAgent); }
function isIOS(){ return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream; }

/* ================= VIEWER COUNT ================= */
const viewerCountRef = db.ref('meta/viewerCount');
viewerCountRef.once('value', snap=>{ if(snap.val()===null) viewerCountRef.set(0); });
viewerCountRef.on('value', snap=>{ const v = snap.val()||0; viewerCountAdmin.innerText=v; viewerCountViewer.innerText=v; });
async function incViewerCount(){ await viewerCountRef.transaction(n=>(n||0)+1); }
async function decViewerCount(){ await viewerCountRef.transaction(n=>Math.max(0,(n||0)-1)); }

/* ================= CHAT ================= */
const chatRef = db.ref('chat');
chatRef.on('child_added', snap=>{ appendChat(snap.val().time + ' ' + snap.val().text); });
function pushChat(name,text){ chatRef.push({time:now(), text:name+': '+text}); }
clearChatBtn.onclick=()=>{ if(!isAdmin) return; db.ref('chat').remove(); chatBoxes.forEach(cb=>cb.innerHTML=''); };

/* ================= ENTRY ================= */
enterBtn.onclick=()=>{
  const pass = passwordInput.value.trim();
  const name = nameInput.value.trim();

  if(isIOS()){
    // iOS cannot be admin
    isAdmin=false;
    viewerId=genId(10);
    entryCard.style.display='none'; adminCard.style.display='none'; viewerCard.style.display='block';
    viewerNameLabel.innerText = name || 'Anonymous';
    db.ref('viewers/'+viewerId).set({name:name||'Anonymous', joined:now()}); incViewerCount();
    requestOfferAsViewer(viewerId,name||'Anonymous');
    appendChat("System: iOS detected. Joined as viewer only.");
    window.addEventListener('unload',()=>{ db.ref('viewers/'+viewerId).remove(); decViewerCount(); });
    return;
  }

  if(pass===ADMIN_PASSWORD){
    isAdmin=true;
    entryCard.style.display='none'; adminCard.style.display='block'; viewerCard.style.display='none';
    appendChat('System: Admin signed in at '+now()); listenForViewerRequests();
  } else {
    isAdmin=false; viewerId=genId(10);
    entryCard.style.display='none'; adminCard.style.display='none'; viewerCard.style.display='block';
    viewerNameLabel.innerText=name||'Anonymous';
    db.ref('viewers/'+viewerId).set({name:name||'Anonymous', joined:now()}); incViewerCount();
    requestOfferAsViewer(viewerId,name||'Anonymous');
    appendChat('System: Viewer joined as '+(name||'Anonymous')+' at '+now());
    window.addEventListener('unload',()=>{ db.ref('viewers/'+viewerId).remove(); decViewerCount(); });
  }
};

/* ================= ADMIN: LISTEN VIEWERS ================= */
const requestsRef = db.ref('requests');
const offersRef = db.ref('offers');
const answersRef = db.ref('answers');
const iceViewerRefRoot = db.ref('ice/viewer');
const iceAdminRefRoot = db.ref('ice/admin');

async function listenForViewerRequests(){
  requestsRef.on('child_added', async snap=>{
    const vId = snap.key, data = snap.val();
    if(!vId) return;
    if(!localStream){ db.ref('offers/'+vId).set({error:'broadcaster-not-ready'}); return; }
    const pc = new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
    pcs[vId]=pc; localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
    pc.onicecandidate=e=>{ if(e.candidate) iceAdminRefRoot.child(vId).push(JSON.stringify(e.candidate)); };
    try{ const offer = await pc.createOffer(); await pc.setLocalDescription(offer); await offersRef.child(vId).set(JSON.stringify(offer)); }catch(e){console.error(e);}
    answersRef.child(vId).on('value',snapAnswer=>{ const val=snapAnswer.val(); if(!val) return; try{ pc.setRemoteDescription(JSON.parse(val)); requestsRef.child(vId).remove().catch(()=>{}); }catch(e){console.warn(e);} });
    iceViewerRefRoot.child(vId).on('child_added',snapIce=>{ try{ pc.addIceCandidate(new RTCIceCandidate(JSON.parse(snapIce.val()))).catch(()=>{}); }catch(e){console.warn(e);} });
    pc.onconnectionstatechange=()=>{ if(['closed','failed','disconnected'].includes(pc.connectionState)){ answersRef.child(vId).off(); iceViewerRefRoot.child(vId).off(); iceAdminRefRoot.child(vId).remove().catch(()=>{}); offersRef.child(vId).remove().catch(()=>{}); delete pcs[vId]; } };
  });
}

/* ================= ADMIN: START / STOP ================= */
startBtn.onclick=async()=>{
  if(!navigator.mediaDevices.getDisplayMedia){ alert('Screen sharing unsupported. Use Chrome 89+ on PC/Android.'); return; }
  try{ localStream=await navigator.mediaDevices.getDisplayMedia({video:true,audio:true}); }catch(e){ alert('Cannot share: '+e.message); return; }
  localVideo.srcObject=localStream;
  appendChat('Admin: started sharing at '+now()+' (Mobile: '+isMobile()+')');
  db.ref('meta/broadcaster').set({online:true,startedAt:now(), mobile:isMobile()});
};
stopBtn.onclick=()=>{
  if(localStream){ localStream.getTracks().forEach(t=>t.stop()); localStream=null; localVideo.srcObject=null; }
  db.ref('meta/broadcaster').set({online:false,stoppedAt:now()});
  requestsRef.remove().catch(()=>{}); offersRef.remove().catch(()=>{}); answersRef.remove().catch(()=>{}); iceViewerRefRoot.remove().catch(()=>{}); iceAdminRefRoot.remove().catch(()=>{});
  appendChat('Admin: stopped sharing at '+now()); Object.keys(pcs).forEach(id=>{ pcs[id].close(); answersRef.child(id).off(); iceViewerRefRoot.child(id).off(); }); pcs={};
};

/* ================= VIEWER OFFER ================= */
async function requestOfferAsViewer(myViewerId,name){
  await requestsRef.child(myViewerId).set({name:name, createdAt:now()});
  const pc=new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
  pc.onicecandidate=e=>{ if(e.candidate) iceViewerRefRoot.child(myViewerId).push(JSON.stringify(e.candidate)); };
  pc.ontrack=e=>{ remoteVideo.srcObject=e.streams[0]; };
  offersRef.child(myViewerId).on('value',async snap=>{
    const val=snap.val(); if(!val) return;
    if(val.error==='broadcaster-not-ready'){ appendChat('System: broadcaster not ready. Please wait...'); return; }
    try{ await pc.setRemoteDescription(JSON.parse(val)); const ans=await pc.createAnswer(); await pc.setLocalDescription(ans); await answersRef.child(myViewerId).set(JSON.stringify(ans));
      iceAdminRefRoot.child(myViewerId).on('child_added',s=>{ try{ pc.addIceCandidate(new RTCIceCandidate(JSON.parse(s.val()))).catch(()=>{}); }catch(e){console.warn(e);} });
    }catch(e){console.error(e);}
  });
  db.ref('viewers/'+myViewerId).update({connectedAt:now()});
  setTimeout(()=>requestsRef.child(myViewerId).remove().catch(()=>{}),60000);
}

/* ================= CHAT SEND ================= */
sendMsg.onclick=()=>{ const t=msgInput.value.trim(); if(!t) return; pushChat(nameInput.value.trim()||'Anonymous',t); msgInput.value=''; }
sendAdminMsg.onclick=()=>{ if(!isAdmin) return; const t=adminMsg.value.trim(); if(!t) return; pushChat('Admin',t); adminMsg.value=''; }

/* ================= FULLSCREEN ================= */
fullscreenBtn.onclick=()=>{ const v=remoteVideo; if(v.requestFullscreen)v.requestFullscreen(); else if(v.webkitRequestFullscreen)v.webkitRequestFullscreen(); else alert('Fullscreen unsupported'); }

/* ================= VIEWER LIST ================= */
const viewersListRef=db.ref('viewers');
viewersListRef.on('child_added',snap=>{ const val=snap.val(); const div=document.createElement('div'); div.id='viewer-'+snap.key; div.innerText=val.name+' (joined at '+(val.joined||now())+')'; viewersListEl.appendChild(div); });
viewersListRef.on('child_removed',snap=>{ const el=document.getElementById('viewer-'+snap.key); if(el) el.remove(); });

</script>
</body>
</html>
